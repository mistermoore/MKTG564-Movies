---
title: "Predicting The Next Blockbuster"
author: "Team 1"
date: "March 14, 2019"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(lubridate)
library(stringr)
library(tidyr)
library(dplyr)
library(ggplot2)
library(scales)
library(reshape2)
```

# Executive Summary
-Business Background & Question To Answer
-Data Used
-Methods
-Results
-Recommendation

# Data Summary
-IMDB Data Background
-Data Structure and Contents

## Movies Metadata
```{r}
# Define the columns in the movies_metada dataset
movies = read.csv('../Data/movies_metadata.csv')
colnames(movies)
```
### Movies Metadata Column definitions

|Field|Data Type|Definition|
|-----+----------------+-------------------------------------------------------------------------------------------------|
|adult|Boolean|Indicates if the movie is adult content (TRUE)|
|belongs_to_collection|List|If the movie is part of a collection, lists the name of the collection information|
|budget|Numeric|Dollar value of the production budget|
|genres|List|All genres associated with the film in order of importance to the film|
|homepage|String|Website of the film if available|
|id|Numeric|ID value for the film|
|imdb_id|String|IMDB URL Value for the film|
|original_language|String|Two letter code for production language|
|original_title|String|Working title of the film|
|overview|String|Brief description of the plot of the film|
|popularity|Numeric|Calculated popularity of the film for recent time period|
|poster_path|String|URL for the film's poster|
|production_companies|List|All production companies involved in production of the film|
|production_countries|List|All countries involved in production of the film|
|release_date|Date|Date of film's theatrical release|
|revenue|Numeric|Revenue generated by the film|
|runtime|Numeric|Film run time in minutes|
|spoken_languages|List|All languages spoken in the film|
|status|String|Status of the films production. In Production, Cancelled, Post Production, Released etc.|
|tagline|String|Marketing tagline for the film if available|
|title|String|Title of the film when released|
|video|Boolean| If the film was released directly to video channels (non-Theatrical)|
|vote_average|Numeric|Average score on IMDB|
|vote_count|Numeric|Number of votes from IMDB users|

### Format and Clean and Factor Engineer Movies Metadata
```{r}
# Create a dataset for manipulation
movies.data = movies

#Convert Data Types As Necessary
movies.data$adult = as.logical(movies.data$adult)
movies.data$video = as.logical(movies.data$video)
movies.data$genres = as.character(movies.data$genres)
movies.data$release_date = ymd(movies.data$release_date)
movies.data$revenue = as.numeric(movies.data$revenue)
movies.data$budget = as.numeric(levels(movies.data$budget))[movies.data$budget]

#Transform Genres into Top 10 Lists
movies.data$genres = gsub("\\[|\\]","",movies.data$genres)
movies.data$genres = gsub("\\{|\\}|'id': \\d+, 'name': |\\ \\{","",movies.data$genres)
movies.data$genres = gsub("'","",movies.data$genres)
movies.data = separate(movies.data, genres, into = paste("Genre", 1:10, sep='_'), sep=',')

#Transform List of Production Companies into fields
movies.data$production_companies = gsub("\\[|\\]","",movies.data$production_companies)
movies.data$production_companies = gsub("\\{'name': |, 'id': \\d+\\}| \\{'name': ","",movies.data$production_companies)
movies.data$production_companies = gsub("'","",movies.data$production_companies)
movies.data = separate(movies.data, production_companies, into = paste("Production_Company", 1:27, sep='_'), sep=',')

#Transform List of Production Countries into fields
movies.data$production_countries = gsub("\\[|\\]","",movies.data$production_countries)
movies.data$production_countries = gsub("\\{'iso_\\d+_\\d+': '\\D{2}', 'name': |\\}","",movies.data$production_countries)
movies.data$production_countries = gsub("'","",movies.data$production_countries)
movies.data = separate(movies.data, production_countries, into = paste("Production_Countries", 1:26, sep='_'), sep=',')

#Transform List of Spoken Languages into fields
movies.data$spoken_languages = gsub("\\[|\\]","",movies.data$spoken_languages)
movies.data$spoken_languages = gsub("\\{|\\}|'iso_\\d+_\\d+': '\\D{2}', 'name': ","",movies.data$spoken_languages)
movies.data$spoken_languages = gsub("'","",movies.data$spoken_languages)
movies.data = separate(movies.data, spoken_languages, into = paste("Spoken_Language", 1:20, sep='_'), sep=',')

#Transform Collection
movies.data$belongs_to_collection = str_extract_all(movies.data$belongs_to_collection,"(?<='name': ')(.*)(?=', 'poster_path)", simplify = TRUE)

#Add New Fields
movies.data$profit = movies.data$revenue - movies.data$budget

```

## Credits Data
```{r}
# Define the columns in the Credits data set
credits = read.csv('../Data/credits.csv')
colnames(credits)
```
### Credits Data Column Definitions
|Field|Data Type|Definition|
|-----+----------------+-------------------------------------------------------------------------------------------------|
|cast|List|Every actor receiving billing in the credits, in order of IMDB Listing (Popularity)|
|crew|List|Every crew member receiving billing in the credits, in order of department and IMDB Listing (Popularity)|
|id|int|IMDB id for linking to other data|

### Format and Clean Up Credits Data
```{r}
# Create A Data Set for Manipulation
credits.data = credits

#Top 10 billed Actors
credits.data$cast = gsub("\\[|\\]","",credits.data$cast)
credits.data$cast = str_extract_all(credits.data$cast,"(?<='name': ')(.*?)(?=', 'order':)",simplify = FALSE)
credits.data$cast = gsub("character\\(0|c\\(|\\)|\\\"","",credits.data$cast)
credits.data = separate(credits.data, cast, into = paste("ACTOR", 1:10, sep='_'), sep=',')

#Up to 3 Directors
credits.data$directors = str_extract_all(credits.data$crew,"(?<='Director', 'name': ')(.*?)(?=', 'profile_path':)",simplify = FALSE)
credits.data$directors = gsub("character\\(0|c\\(|\\)|\\\"","",credits.data$directors)
credits.data = separate(credits.data, directors, into = paste("Director", 1:3, sep='_'), sep=',')

#Up to 3 Screenplay
credits.data$screenplay = str_extract_all(credits.data$crew,"(?<='Screenplay', 'name': ')(.*?)(?=', 'profile_path':)",simplify = FALSE)
credits.data$screenplay = gsub("character\\(0|c\\(|\\)|\\\"","",credits.data$screenplay)
credits.data = separate(credits.data, screenplay, into = paste("Screenplay", 1:3, sep='_'), sep=',')

#Up to 3 Writers
credits.data$writer = str_extract_all(credits.data$crew,"(?<='Writer', 'name': ')(.*?)(?=', 'profile_path':)",simplify = FALSE)
credits.data$writer = gsub("character\\(0|c\\(|\\)|\\\"","",credits.data$writer)
credits.data = separate(credits.data, writer, into = paste("Writer", 1:3, sep='_'), sep=',')
#Convert Blank Cells to NA

# Function to Create Null Values for missing
empty_as_na <- function(x){
    if("factor" %in% class(x)) x <- as.character(x) ## since ifelse wont work with factors
    ifelse(as.character(x)!="", x, NA)
}

#Reformat Blanks
credits.data = credits.data %>% mutate_all(funs(empty_as_na)) 
```

## Descriptive Statistics
Descriptions of the entire data set to determine interesting factors and relevant data for further analysis. First we remove movies that are irrelevant to our study (films that are in production, adult films, direct to video) or are missing important factors (no budget or revenue information, foreign films etc). From our original 45,476 movies, 4,786 remain. In order to make the data easier to analyze we will also combine the Movies and Credits datasets. At this time, movie profit is calculated as revenue-budget.
```{r}
# Format Data As Necessary
movies.data$belongs_to_collection = as.factor(movies.data$belongs_to_collection)
# Scrubbing for misisng factors or unimportant data
movies.data$release_date = as.Date(movies.data$release_date)

# Not Adult
movies.data = movies.data[movies.data$adult == FALSE,]
# Budget > 0
movies.data = movies.data[movies.data$budget > 0,]
# Revenue > 0
movies.data = movies.data[movies.data$revenue > 0,]
# At least 1 genre
movies.data = movies.data[!is.null(movies.data$Genre_1),]
movies.data = movies.data[movies.data$Genre_1 != '',]
# English Movies
movies.data = movies.data[movies.data$original_language == 'en',]
# At least 1 production company
movies.data = movies.data[!is.na(movies.data$Production_Company_1),]
# Movie has been released
movies.data = movies.data[movies.data$status == 'Released',]
# Theatrical Release
movies.data = movies.data[movies.data$video == FALSE,]

# Combine Movies and Credits data
movies.cast = merge(x = movies.data, y = credits.data, by = 'id', all.x = TRUE)

# Caclculate Movie Profit (revenue-budget)
#Add New Fields
movies.cast$profit = movies.cast$revenue - movies.cast$budget
```

### Profitability

```{r}
# Summary of Profit for the dataset
print('Summary of Movie Profitability')
summary(movies.cast$profit)
# Histogram of Profitability
ggplot(data = movies.cast, aes(x=profit/1000000)) + geom_histogram(binwidth=10) +
  labs(title='Movie Profits', x='Profit in Millions') + scale_x_continuous(label=comma)
# Measure of Annual Profit
ggplot(data = movies.cast, aes(x=year(release_date), y=profit/1000000, group=year(release_date))) +
  geom_boxplot() + labs(title='Movie Profits by Year', x='Year of Release', y='Profit in Millions') +
  scale_y_continuous(label=comma)
# Measure of Average Profits by Time
annual_profit = movies.cast %>%
  group_by(year(release_date)) %>%
  summarise(
    Mean_Profit = mean(profit),
    Median_Profit = median(profit),
    SD_Profit = sd(profit)
  )

ggplot(annual_profit, aes(x=annual_profit$`year(release_date)`, y= Mean_Profit/1000000)) + geom_line(color='blue') + geom_line(y=annual_profit$Median_Profit/1000000, color='red') + labs(title='Mean and Median Annual Profit', x='Year of Release', y='Profit in Millions')

# Movie Profits vs Budget
ggplot(data=movies.cast, aes(x=budget/1000000,y=profit/1000000)) + geom_point() +
  labs(title='Profit vs Budget', x='Budget in Millions', y='Profit in Millions') +
  scale_x_continuous(label=comma) +
  scale_y_continuous(label=comma)

```
FILL WITH ANALYSIS OF PROBABILITY IN DATASET
### Genres
```{r}
# Primary Genre analysis
movie.genre1 = melt(movies.data, id.vars = c('title','budget','revenue','profit'), measure.vars=5, na.rm=TRUE)
# Summarize by Genre
genre1.summary = movie.genre1 %>%
  group_by(value) %>%
  summarise(mean_budget = mean(budget),
            sd_budget = sd(budget),
            median_budget = median(budget),
            mean_revenue = mean(revenue),
            sd_revenue = sd(revenue),
            median_revenue = median(revenue),
            mean_profit = mean(profit),
            sd_profit = sd(profit),
            median_profit = median(profit))
# By genre1 analysis
ggplot(movie.genre1,aes(value , profit/1000000)) +
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title='Profit by Primary Genre', y='Profit in Millions', x='Primary Genre')

# Paired Genre Analysis
# Create master genre by combining first two listed genres
movies.data$genre = paste(movies.data$Genre_1,movies.data$Genre_2)
movie.genre = melt(movies.data, id.vars= c('title','budget','revenue','profit', 'Genre_1'), measure.vars = 105 , na.rm=TRUE)

#Summarize by paired Genre
genre.summary = movie.genre %>%
  group_by(value) %>%
  summarise(mean_budget = mean(budget),
            sd_budget = sd(budget),
            median_budget = median(budget),
            mean_revenue = mean(revenue),
            sd_revenue = sd(revenue),
            median_revenue = median(revenue),
            mean_profit = mean(profit),
            sd_profit = sd(profit),
            median_profit = median(profit))

#By paired genre analysis
ggplot(movie.genre[movie.genre$Genre_1 == c('Action','War','Comedy'),],aes(value , profit/1000000)) +
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + facet_grid(rows=vars(Genre_1)) +
  labs(title='Profit by Paired Genre', y='Profit in Millions', x='paired Genre')
```

FILL WITH ANALYSIS OF GENRE FACTORS

## Primary Production Company Description
```{r}
movie.prod = melt(movies.data, id.vars= c('title','budget','revenue','profit'), measure.vars = 22 , na.rm=TRUE)

#Summarize by Company
prod.summary = movie.prod %>%
  group_by(value) %>%
  summarise(mean_budget = mean(budget),
            sd_budget = sd(budget),
            median_budget = median(budget),
            mean_revenue = mean(revenue),
            sd_revenue = sd(revenue),
            median_revenue = median(revenue),
            mean_profit = mean(profit),
            sd_profit = sd(profit),
            median_profit = median(profit),
            count = n())

#By prod company analysis
movie.prod = merge(x=movie.prod, y=prod.summary, by.x='value', by.y = 'value')
ggplot(movie.prod[movie.prod$count >= 30 & movie.prod$value != '',],aes(reorder(value, -count) , profit/1000000)) +
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title='Profit by Production Companies > 30 Titles', x='Company', y='Profit in Millions') +
  scale_y_continuous(label=comma)
```


## Cast Information
```{r}

#Top Billed Actor
movie.actors = melt(movies.cast, id.vars= c('title','budget','revenue','profit','release_date'), measure.vars = 105:114 , na.rm=TRUE)

# Remove actors who haven't been cast since 2000
movie.actors = movie.actors[movie.actors$release_date>='2000-01-01',]

actors.summary = movie.actors %>%
  group_by(value) %>%
  summarise(mean_budget = mean(budget),
            sd_budget = sd(budget),
            median_budget = median(budget),
            mean_revenue = mean(revenue),
            sd_revenue = sd(revenue),
            median_revenue = median(revenue),
            mean_profit = mean(profit),
            sd_profit = sd(profit),
            median_profit = median(profit),
            count = n())
#Actors in more than 20 films
ggplot(actors.summary[actors.summary$count >= 20,], aes(reorder(value, -count),mean_profit/1000000)) +
  geom_point() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(title='Actors in More than 20 Films',x='Actor (Ordered by Appearances)', y='Average Profit')
```